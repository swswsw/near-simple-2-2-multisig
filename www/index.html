<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/near-api-js@0.41.0/dist/near-api-js.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>

<button id="sign-in">Sign-in</button>
</body>

<script>

// reference for near-api-js flow: https://docs.near.org/docs/api/naj-quick-reference
// difference from the above doc: import near-api-js in the script will give me nearApi object.  we will need to reference that.  
const { connect, keyStores, WalletConnection } = nearApi;

// also, taking example from https://github.com/near-examples/wallet-example/blob/master/src/main.js

const contractName ='dev-1643363054216-73116405445411';

// this is replaced by initContract()
async function initNear() {
    const config = {
        networkId: "testnet",
        keyStore: new nearApi.keyStores.BrowserLocalStorageKeyStore(), 
        nodeUrl: "https://rpc.testnet.near.org",
        walletUrl: "https://wallet.testnet.near.org",
        helperUrl: "https://helper.testnet.near.org",
        explorerUrl: "https://explorer.testnet.near.org",
    };

    // connect to NEAR
    const near = await connect(config);

    // create wallet connection
    const wallet = new WalletConnection(near);
    
    const walletAccountId = wallet.getAccountId();
    console.log("accountid=", walletAccountId); // if not login, it is empty.
}

// Initializing contract
async function initContract() {
  // this is taken from https://github.com/near-examples/wallet-example/blob/master/src/main.js. 
  // this way of adding object to window object is probably not preferrable. 

  const config = {
        networkId: "testnet",
        keyStore: new nearApi.keyStores.BrowserLocalStorageKeyStore(), 
        nodeUrl: "https://rpc.testnet.near.org",
        walletUrl: "https://wallet.testnet.near.org",
        helperUrl: "https://helper.testnet.near.org",
        explorerUrl: "https://explorer.testnet.near.org",
    };

  // Initializing connection to the NEAR node.
  window.near = await connect(config);

  window.wallet = new WalletConnection(near);
  // Initializing Wallet based Account. It can work with NEAR TestNet wallet that
  // is hosted at https://wallet.testnet.near.org
  window.walletAccount = new nearApi.WalletAccount(window.near);

  // Getting the Account ID. If unauthorized yet, it's just empty string.
  window.accountId = window.walletAccount.getAccountId();

  // Initializing our contract APIs by contract name and configuration.
  window.contract = await window.near.loadContract(contractName, {
    // View methods are read only. They don't modify the state, but usually return some value.
    viewMethods: [],
    // Change methods can modify the state. But you don't receive the returned value when called.
    changeMethods: ['deposit','withdraw'],
    // Sender is the account ID to initialize transactions.
    sender: window.accountId,
  });
}


// redirects user to wallet to authorize your dApp
// this creates an access key that will be stored in the browser's local storage
// access key can then be used to connect to NEAR and sign transactions via keyStore

const signIn = () => {
  wallet.requestSignIn(
    contractName, // contract requesting access
    "2-of-2 Multisig", // optional
    //"http://YOUR-URL.com/success", // optional
    //"http://YOUR-URL.com/failure" // optional
  );
};

const signOut = () => {
  wallet.signOut();
};


// Using initialized contract
async function doWork() {
  // Based on whether you've authorized, checking which flow we should go.
  if (!window.walletAccount.isSignedIn()) {
    signedOutFlow();
  } else {
    signedInFlow();
  }
}

function signedOutFlow() {
  // Adding an event to a sing-in button.
  document.getElementById('sign-in').addEventListener('click', () => {
    window.walletAccount.requestSignIn(
      // The contract name that would be authorized to be called by the user's account.
      contractName,
      // This is the app name. It can be anything.
      '2-of-2 Multisig Wallet',
      // We can also provide URLs to redirect on success and failure.
      // The current URL is used by default.
    );
  });
}

// Main function for the signed-in flow (already authorized by the wallet).
function signedInFlow() {

}



// Loads nearAPI and this contract into window scope.
window.nearInitPromise = initContract()
  .then(doWork)
  .catch(console.error);
</script>

</html>